<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Tiles - Level 2: Add & Subtract</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .problem-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .problem-text {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: 600;
        }

        .problem-buttons {
            display: flex;
            gap: 10px;
        }

        .new-problem-btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .new-problem-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .quit-btn {
            padding: 12px 24px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .quit-btn:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .help-btn {
            padding: 12px 24px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .help-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .help-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .help-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #856404;
            font-weight: 600;
            display: none;
        }

        .help-message.show {
            display: block;
        }

        .workspace {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .palette {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .palette h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #333;
        }

        .tile-group {
            margin-bottom: 25px;
        }

        .tile-group h3 {
            font-size: 1em;
            margin-bottom: 10px;
            color: #666;
            font-weight: 600;
        }

        .palette-tiles {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tile-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tile-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-input {
            width: 50px;
            padding: 5px 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }

        .add-btn {
            padding: 5px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .add-btn:hover {
            background: #229954;
        }

        .canvas {
            background: white;
            border-radius: 12px;
            min-height: 600px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            display: grid;
            grid-template-columns: 4fr 1fr; /* 80% work area, 20% remove zone */
        }

        .main-work-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 600px;
        }

        .work-area {
            position: relative;
            height: 40%; /* Top 40% */
            border-bottom: 2px dashed #999;
            padding: 10px;
        }

        .zero-pairs-area {
            position: relative;
            height: 60%; /* Bottom 60% */
            background: #f8f9fa;
            padding: 10px;
        }

        .zero-pairs-label {
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 10px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .zero-pairs-content {
            position: relative;
            width: 100%;
            height: calc(100% - 60px); /* Account for label height */
        }

        .remove-zone {
            position: relative;
            background: linear-gradient(135deg, #ffe5e5 0%, #ffcccc 100%);
            border-left: 3px solid #e74c3c;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .zone-label {
            background: rgba(231, 76, 60, 0.95);
            color: white;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .zone-content {
            position: relative;
            flex: 1;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            border: 2px dashed #e74c3c;
        }

        .tile {
            position: absolute;
            cursor: move;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: rgba(0,0,0,0.7);
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: box-shadow 0.1s;
        }

        .tile:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tile.dragging {
            opacity: 0.7;
            z-index: 1000;
        }

        .tile.selected {
            outline: 3px solid #9b59b6;
            outline-offset: 2px;
        }

        /* Positive tiles - Blue */
        .tile.x2-pos { 
            background: #4A90E2;
            width: 100px;
            height: 100px;
        }

        .tile.x-pos { 
            background: #4A90E2;
            width: 100px;
            height: 10px;
        }

        .tile.unit-pos { 
            background: #4A90E2;
            width: 10px;
            height: 10px;
        }

        /* Negative tiles - Orange */
        .tile.x2-neg { 
            background: #E8833A;
            width: 100px;
            height: 100px;
        }

        .tile.x-neg { 
            background: #E8833A;
            width: 100px;
            height: 10px;
        }

        .tile.unit-neg { 
            background: #E8833A;
            width: 10px;
            height: 10px;
        }

        .palette-tile {
            position: relative;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: rgba(0,0,0,0.7);
            user-select: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.2s;
            margin: 0 auto;
        }

        .palette-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .palette-tile.x2-pos,
        .palette-tile.x2-neg {
            width: 80px;
            height: 80px;
        }

        .palette-tile.x-pos,
        .palette-tile.x-neg {
            width: 80px;
            height: 10px;
        }

        .palette-tile.unit-pos,
        .palette-tile.unit-neg {
            width: 10px;
            height: 10px;
        }

        .answer-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .answer-label {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .answer-input-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .answer-input {
            flex: 1;
            padding: 15px;
            font-size: 1.3em;
            border: 3px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.2s;
        }

        .answer-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .submit-btn {
            padding: 15px 40px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .submit-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .feedback {
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .hint-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
            font-style: italic;
        }

        .legend {
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .info-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 15px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        button.rotate-btn {
            padding: 12px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        button.rotate-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        button.rotate-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        button.clear-btn {
            padding: 12px 30px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        button.clear-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Focus styles for accessibility */
        button:focus,
        .palette-tile:focus,
        .quantity-input:focus,
        .answer-input:focus {
            outline: 3px solid #fff;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .tile {
                border: 3px solid #000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <header>
            <h1>ðŸ§® Algebra Tiles - Level 2</h1>
            <p class="subtitle">Add or Subtract Algebraic Expressions</p>
        </header>
        
        <div class="info-box" role="status" aria-live="polite">
            ðŸ’¡ Use tiles to visualize the problem, then enter your answer symbolically
        </div>

        <section class="problem-section" aria-labelledby="problem-heading">
            <div class="problem-header">
                <div class="problem-text" id="problem-heading" role="heading" aria-level="2">Loading problem...</div>
                <div class="problem-buttons">
                    <button class="help-btn" 
                            id="helpBtn" 
                            onclick="showHelp()" 
                            style="display: none;"
                            aria-label="Get help by adding zero pairs for subtraction">Help</button>
                    <button class="new-problem-btn" 
                            onclick="generateNewProblem()"
                            aria-label="Generate a new practice problem">New Problem</button>
                    <button class="quit-btn" 
                            onclick="quitLevel()"
                            aria-label="Return to main menu">Quit to Main</button>
                </div>
            </div>
            <div class="help-message" id="helpMessage" role="alert" aria-live="assertive"></div>
        </section>

        <main id="main-content">
            <div class="workspace">
                <aside class="palette" aria-label="Tile palette">
                <h2>Tile Palette</h2>
                
                <div class="tile-group">
                    <h3>Positive (Blue)</h3>
                    <div class="palette-tiles">
                        <div class="tile-row">
                            <div class="palette-tile x2-pos" data-type="x2-pos">xÂ²</div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">xÂ² tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-x2-pos" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('x2-pos', 'qty-x2-pos')">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="tile-row">
                            <div class="palette-tile x-pos" data-type="x-pos">x</div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">x tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-x-pos" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('x-pos', 'qty-x-pos')">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="tile-row">
                            <div class="palette-tile unit-pos" data-type="unit-pos"></div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">1 tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-unit-pos" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('unit-pos', 'qty-unit-pos')">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tile-group">
                    <h3>Negative (Orange)</h3>
                    <div class="palette-tiles">
                        <div class="tile-row">
                            <div class="palette-tile x2-neg" data-type="x2-neg">-xÂ²</div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">-xÂ² tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-x2-neg" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('x2-neg', 'qty-x2-neg')">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="tile-row">
                            <div class="palette-tile x-neg" data-type="x-neg">-x</div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">-x tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-x-neg" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('x-neg', 'qty-x-neg')">Add</button>
                                </div>
                            </div>
                        </div>
                        <div class="tile-row">
                            <div class="palette-tile unit-neg" data-type="unit-neg"></div>
                            <div class="tile-controls">
                                <div style="font-size: 0.9em;">-1 tile</div>
                                <div class="quantity-control">
                                    <input type="number" class="quantity-input" id="qty-unit-neg" min="1" max="20" value="1">
                                    <button class="add-btn" onclick="addMultipleTiles('unit-neg', 'qty-unit-neg')">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="legend">
                    <strong>Color Legend:</strong>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4A90E2;"></div>
                        <span>Positive values</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #E8833A;"></div>
                        <span>Negative values</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                    <strong>Keyboard Shortcuts:</strong>
                    <div style="font-size: 0.85em; margin-top: 5px; line-height: 1.6;">
                        <div>â€¢ Arrow Keys: Move tile</div>
                        <div>â€¢ Shift + Arrow: Move faster</div>
                        <div>â€¢ R: Rotate x tiles</div>
                        <div>â€¢ Delete: Remove tile</div>
                    </div>
                </div>
            </aside>

            <div class="canvas" id="canvas" role="application" aria-label="Algebra tiles workspace">
                <div class="main-work-container">
                    <div class="work-area" id="workArea">
                        <!-- Initial expression tiles go here (top half) -->
                    </div>
                    <div class="zero-pairs-area" id="zeroPairsArea">
                        <div class="zero-pairs-label">
                            âž• Zero Pairs Area
                            <div style="font-size: 0.75em; margin-top: 3px; font-weight: normal;">
                                Zero pairs (Â±) added by Help button appear here
                            </div>
                        </div>
                        <div class="zero-pairs-content" id="zeroPairsContent">
                            <!-- Zero pairs will be added here (bottom 5/8) -->
                        </div>
                    </div>
                </div>
                <div class="remove-zone" id="removeZone">
                    <div class="zone-label" role="heading" aria-level="3">
                        âœ— Remove Zone
                        <div style="font-size: 0.75em; margin-top: 3px; font-weight: normal;">
                            Drag tiles here to subtract
                        </div>
                    </div>
                    <div class="zone-content">
                        <!-- Tiles to remove will be dragged here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="rotate-btn" id="rotateBtn" onclick="rotateSelected()" disabled>Rotate Selected Tile</button>
            <button class="clear-btn" onclick="clearUserTiles()">Clear My Tiles</button>
        </div>

        <section class="answer-section" aria-labelledby="answer-heading">
            <label for="answerInput" id="answer-heading" class="answer-label">Enter your answer (e.g., 2xÂ² + 3x - 5 or just 0):</label>
            <div class="answer-input-group">
                <input type="text" 
                       id="answerInput" 
                       class="answer-input" 
                       placeholder="Type your answer here..."
                       aria-describedby="hint-text"
                       aria-label="Answer input field">
                <button class="submit-btn" 
                        onclick="checkAnswer()"
                        aria-label="Submit your answer for checking">Submit Answer</button>
            </div>
            <div id="hint-text" class="hint-text">Tip: You can use tiles to help visualize, or work it out on your own!</div>
            <div class="feedback" 
                 id="feedback" 
                 role="alert" 
                 aria-live="assertive" 
                 aria-atomic="true"></div>
        </section>
        </main>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const workArea = document.getElementById('workArea');
        const zeroPairsArea = document.getElementById('zeroPairsArea');
        const zeroPairsContent = document.getElementById('zeroPairsContent');
        const removeZone = document.getElementById('removeZone');
        const rotateBtn = document.getElementById('rotateBtn');
        const answerInput = document.getElementById('answerInput');
        const feedback = document.getElementById('feedback');
        const helpBtn = document.getElementById('helpBtn');
        const helpMessage = document.getElementById('helpMessage');
        
        let draggedElement = null;
        let selectedTile = null;
        let offsetX = 0;
        let offsetY = 0;
        let tileCounter = 0;
        let isDragging = false;

        let currentProblem = null;
        let helpUsed = false;

        // Problem generation
        function generateExpression(maxTerms = 3) {
            const terms = [];
            const hasX2 = Math.random() > 0.5;
            const hasX = Math.random() > 0.5;
            const hasConstant = Math.random() > 0.5;

            let x2 = 0, x = 0, constant = 0;

            if (hasX2) {
                x2 = Math.floor(Math.random() * 5) + 1;
                if (Math.random() > 0.5) x2 = -x2;
            }
            if (hasX) {
                x = Math.floor(Math.random() * 8) + 1;
                if (Math.random() > 0.5) x = -x;
            }
            if (hasConstant) {
                constant = Math.floor(Math.random() * 10) + 1;
                if (Math.random() > 0.5) constant = -constant;
            }

            // Ensure at least one term
            if (x2 === 0 && x === 0 && constant === 0) {
                constant = Math.floor(Math.random() * 5) + 1;
            }

            return { x2, x, constant };
        }

        function expressionToString(expr) {
            let str = '';
            
            if (expr.x2 !== 0) {
                if (expr.x2 === 1) str += 'xÂ²';
                else if (expr.x2 === -1) str += '-xÂ²';
                else str += expr.x2 + 'xÂ²';
            }
            
            if (expr.x !== 0) {
                if (str !== '' && expr.x > 0) str += ' + ';
                else if (str !== '' && expr.x < 0) str += ' - ';
                
                const absX = Math.abs(expr.x);
                if (expr.x === 1 && str === '') str += 'x';
                else if (expr.x === -1 && str === '') str += '-x';
                else if (absX === 1 && str !== '') str += 'x';
                else if (str !== '' && expr.x < 0) str += absX + 'x';
                else str += expr.x + 'x';
            }
            
            if (expr.constant !== 0) {
                if (str !== '' && expr.constant > 0) str += ' + ' + expr.constant;
                else if (str !== '' && expr.constant < 0) str += ' - ' + Math.abs(expr.constant);
                else str += expr.constant;
            }
            
            if (str === '') str = '0';
            return str;
        }

        function generateNewProblem() {
            const expr1 = generateExpression();
            const expr2 = generateExpression();
            const operation = Math.random() > 0.5 ? 'add' : 'subtract';

            let answer;
            if (operation === 'add') {
                answer = {
                    x2: expr1.x2 + expr2.x2,
                    x: expr1.x + expr2.x,
                    constant: expr1.constant + expr2.constant
                };
            } else {
                answer = {
                    x2: expr1.x2 - expr2.x2,
                    x: expr1.x - expr2.x,
                    constant: expr1.constant - expr2.constant
                };
            }

            currentProblem = {
                expr1,
                expr2,
                operation,
                answer
            };

            const operationSymbol = operation === 'add' ? '+' : '-';
            const problemText = `(${expressionToString(expr1)}) ${operationSymbol} (${expressionToString(expr2)})`;
            document.getElementById('problem-heading').textContent = problemText;

            // Show help button only for subtraction problems
            if (operation === 'subtract') {
                helpBtn.style.display = 'inline-block';
            } else {
                helpBtn.style.display = 'none';
            }

            // Reset help state
            helpUsed = false;
            helpBtn.disabled = false;
            helpMessage.classList.remove('show');

            // Clear canvas and feedback
            clearCanvas();
            feedback.classList.remove('show', 'correct', 'incorrect');
            answerInput.value = '';

            // Place first expression tiles
            placeInitialTiles(expr1);
        }

        function placeInitialTiles(expr) {
            const workAreaRect = workArea.getBoundingClientRect();
            const startX = 50;
            let currentY = 50;

            // Place xÂ² tiles with proper spacing
            for (let i = 0; i < Math.abs(expr.x2); i++) {
                const type = expr.x2 > 0 ? 'x2-pos' : 'x2-neg';
                const col = i % 5; // 5 tiles per row
                const row = Math.floor(i / 5);
                const x = startX + col * 110; // 100px tile + 10px spacing
                const y = currentY + row * 110;
                createTile(type, x, y, true);
            }
            if (expr.x2 !== 0) {
                const rows = Math.ceil(Math.abs(expr.x2) / 5);
                currentY += rows * 110 + 15; // Add spacing between tile types
            }

            // Place x tiles VERTICALLY (rotated 90 degrees) with proper spacing
            for (let i = 0; i < Math.abs(expr.x); i++) {
                const type = expr.x > 0 ? 'x-pos' : 'x-neg';
                const x = startX + i * 20; // 20px spacing for vertical tiles
                const tile = createTile(type, x, currentY, true);
                // Rotate to vertical position
                tile.dataset.rotation = '90';
                tile.style.transform = 'rotate(90deg)';
            }
            if (expr.x !== 0) currentY += 120; // Space for rotated tiles + gap

            // Place unit tiles with proper spacing
            for (let i = 0; i < Math.abs(expr.constant); i++) {
                const type = expr.constant > 0 ? 'unit-pos' : 'unit-neg';
                const col = i % 20; // 20 tiles per row
                const row = Math.floor(i / 20);
                const x = startX + col * 15; // 10px tile + 5px spacing
                const y = currentY + row * 15;
                createTile(type, x, y, true);
            }
        }

        function createTile(type, x, y, isInitial = false) {
            const tile = document.createElement('div');
            tile.className = `tile ${type}`;
            tile.style.left = x + 'px';
            tile.style.top = y + 'px';
            tile.dataset.id = tileCounter++;
            tile.dataset.rotation = '0';
            tile.dataset.initial = isInitial ? 'true' : 'false';
            tile.dataset.zone = 'work'; // Track which zone the tile is in
            
            const labels = {
                'x2-pos': 'xÂ²',
                'x-pos': 'x',
                'unit-pos': '1',
                'x2-neg': '-xÂ²',
                'x-neg': '-x',
                'unit-neg': '-1'
            };
            
            tile.textContent = labels[type];
            workArea.appendChild(tile);
            return tile;
        }

        // Simplified event delegation
        canvas.addEventListener('mousedown', function(e) {
            if (e.target.classList.contains('tile') && e.button === 0) {
                e.preventDefault();
                selectTile(e.target);
                startDrag(e.target, e);
            } else if (e.target === canvas || e.target === workArea || e.target.classList.contains('zone-content')) {
                if (selectedTile) {
                    selectedTile.classList.remove('selected');
                    selectedTile = null;
                    updateRotateButton();
                }
            }
        });

        canvas.addEventListener('contextmenu', function(e) {
            if (e.target.classList.contains('tile')) {
                e.preventDefault();
                const tile = e.target;
                if (tile.classList.contains('x-pos') || tile.classList.contains('x-neg')) {
                    rotateTile(tile);
                }
            }
        });

        canvas.addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('tile')) {
                // Don't allow deleting initial tiles
                if (e.target.dataset.initial === 'true') {
                    alert('Cannot delete initial problem tiles. Use "Clear My Tiles" to remove tiles you added.');
                    return;
                }
                if (selectedTile === e.target) {
                    selectedTile = null;
                    updateRotateButton();
                }
                e.target.remove();
            }
        });

        function selectTile(tile) {
            if (selectedTile) {
                selectedTile.classList.remove('selected');
            }
            selectedTile = tile;
            selectedTile.classList.add('selected');
            updateRotateButton();
        }

        function updateRotateButton() {
            if (selectedTile && (selectedTile.classList.contains('x-pos') || selectedTile.classList.contains('x-neg'))) {
                rotateBtn.disabled = false;
            } else {
                rotateBtn.disabled = true;
            }
        }

        function rotateTile(tile) {
            const currentRotation = parseInt(tile.dataset.rotation) || 0;
            const newRotation = (currentRotation + 90) % 360;
            tile.dataset.rotation = newRotation;
            
            if (newRotation === 90 || newRotation === 270) {
                tile.style.transform = `rotate(${newRotation}deg)`;
            } else {
                tile.style.transform = 'none';
            }
        }

        function rotateSelected() {
            if (selectedTile && (selectedTile.classList.contains('x-pos') || selectedTile.classList.contains('x-neg'))) {
                rotateTile(selectedTile);
            }
        }

        function startDrag(tile, e) {
            isDragging = true;
            draggedElement = tile;
            
            const rect = tile.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            
            tile.classList.add('dragging');
        }

        document.addEventListener('mousemove', function(e) {
            if (!isDragging || !draggedElement) return;
            
            e.preventDefault();
            
            // Get mouse position
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            
            // Get all zone boundaries
            const workAreaRect = workArea.getBoundingClientRect();
            const zeroPairsRect = zeroPairsContent.getBoundingClientRect();
            const removeZoneRect = removeZone.getBoundingClientRect();
            
            // Determine which zone the mouse is in
            const isInWorkArea = mouseX >= workAreaRect.left && mouseX <= workAreaRect.right &&
                                  mouseY >= workAreaRect.top && mouseY <= workAreaRect.bottom;
            const isInZeroPairs = mouseX >= zeroPairsRect.left && mouseX <= zeroPairsRect.right &&
                                   mouseY >= zeroPairsRect.top && mouseY <= zeroPairsRect.bottom;
            const isInRemoveZone = mouseX >= removeZoneRect.left && mouseX <= removeZoneRect.right &&
                                    mouseY >= removeZoneRect.top && mouseY <= removeZoneRect.bottom;
            
            // Move tile to appropriate zone if needed
            if (isInRemoveZone && draggedElement.dataset.zone !== 'remove') {
                const zoneContent = removeZone.querySelector('.zone-content');
                zoneContent.appendChild(draggedElement);
                draggedElement.dataset.zone = 'remove';
                draggedElement.style.opacity = '0.7';
            } else if (isInWorkArea && draggedElement.dataset.zone !== 'work') {
                workArea.appendChild(draggedElement);
                draggedElement.dataset.zone = 'work';
                draggedElement.style.opacity = '1';
            } else if (isInZeroPairs && draggedElement.dataset.zone !== 'zero-pairs') {
                zeroPairsContent.appendChild(draggedElement);
                draggedElement.dataset.zone = 'zero-pairs';
                draggedElement.style.opacity = '1';
            }
            
            // Get bounding rect of current parent container
            const parentRect = draggedElement.parentElement.getBoundingClientRect();
            
            let newX = e.clientX - parentRect.left - offsetX;
            let newY = e.clientY - parentRect.top - offsetY;
            
            newX = Math.max(0, Math.min(newX, parentRect.width - draggedElement.offsetWidth));
            newY = Math.max(0, Math.min(newY, parentRect.height - draggedElement.offsetHeight));
            
            draggedElement.style.left = newX + 'px';
            draggedElement.style.top = newY + 'px';
        });

        document.addEventListener('mouseup', function() {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
            isDragging = false;
        });

        document.querySelectorAll('.palette-tile').forEach(paletteTile => {
            paletteTile.addEventListener('click', function(e) {
                const type = this.dataset.type;
                const workAreaRect = workArea.getBoundingClientRect();
                
                const x = (workAreaRect.width / 2) - 50 + (Math.random() - 0.5) * 100;
                const y = (workAreaRect.height / 2) - 50 + (Math.random() - 0.5) * 100;
                
                createTile(type, x, y, false);
            });
        });

        function addMultipleTiles(type, inputId) {
            const input = document.getElementById(inputId);
            let quantity = parseInt(input.value);
            
            if (isNaN(quantity) || quantity < 1) {
                alert('Please enter a valid number (1 or more)');
                input.value = 1;
                return;
            }
            
            if (quantity > 20) {
                alert('Maximum 20 tiles at once');
                input.value = 20;
                quantity = 20;
            }
            
            const workAreaRect = workArea.getBoundingClientRect();
            const centerX = workAreaRect.width / 2;
            const centerY = workAreaRect.height / 2;
            
            let tileWidth, tileHeight;
            if (type.includes('x2')) {
                tileWidth = 100;
                tileHeight = 100;
            } else if (type.includes('x-')) {
                tileWidth = 100;
                tileHeight = 10;
            } else {
                tileWidth = 10;
                tileHeight = 10;
            }
            
            const tilesPerRow = Math.min(Math.ceil(Math.sqrt(quantity)), 10);
            const spacing = 15;
            
            const numRows = Math.ceil(quantity / tilesPerRow);
            const gridWidth = tilesPerRow * (tileWidth + spacing);
            const gridHeight = numRows * (tileHeight + spacing);
            
            const startX = Math.max(50, centerX - gridWidth / 2);
            const startY = Math.max(50, centerY - gridHeight / 2);
            
            for (let i = 0; i < quantity; i++) {
                const row = Math.floor(i / tilesPerRow);
                const col = i % tilesPerRow;
                
                const x = startX + col * (tileWidth + spacing);
                const y = startY + row * (tileHeight + spacing);
                
                if (x >= 0 && y >= 0 && x < workAreaRect.width - tileWidth && y < workAreaRect.height - tileHeight) {
                    createTile(type, x, y, false);
                }
            }
        }

        document.addEventListener('keydown', function(e) {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!selectedTile) return;
                
                const moveAmount = e.shiftKey ? 10 : 1;
                const parentRect = selectedTile.parentElement.getBoundingClientRect();
                
                let currentLeft = parseFloat(selectedTile.style.left) || 0;
                let currentTop = parseFloat(selectedTile.style.top) || 0;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        currentLeft = Math.max(0, currentLeft - moveAmount);
                        selectedTile.style.left = currentLeft + 'px';
                        break;
                    case 'ArrowRight':
                        currentLeft = Math.min(parentRect.width - selectedTile.offsetWidth, currentLeft + moveAmount);
                        selectedTile.style.left = currentLeft + 'px';
                        break;
                    case 'ArrowUp':
                        currentTop = Math.max(0, currentTop - moveAmount);
                        selectedTile.style.top = currentTop + 'px';
                        break;
                    case 'ArrowDown':
                        currentTop = Math.min(parentRect.height - selectedTile.offsetHeight, currentTop + moveAmount);
                        selectedTile.style.top = currentTop + 'px';
                        break;
                }
                return;
            }
            
            if (!selectedTile) return;
            
            switch(e.key) {
                case 'Delete':
                case 'Backspace':
                    e.preventDefault();
                    if (selectedTile.dataset.initial === 'true') {
                        alert('Cannot delete initial problem tiles.');
                        return;
                    }
                    selectedTile.remove();
                    selectedTile = null;
                    updateRotateButton();
                    break;
                case 'r':
                case 'R':
                    if (selectedTile.classList.contains('x-pos') || selectedTile.classList.contains('x-neg')) {
                        rotateTile(selectedTile);
                    }
                    break;
            }
        });

        function clearUserTiles() {
            const tiles = canvas.querySelectorAll('.tile');
            tiles.forEach(tile => {
                if (tile.dataset.initial !== 'true') {
                    tile.remove();
                }
            });
            selectedTile = null;
            updateRotateButton();
        }

        function clearCanvas() {
            workArea.innerHTML = '';
            // Clear zero pairs content
            if (zeroPairsContent) {
                zeroPairsContent.innerHTML = '';
            }
            const zoneContent = removeZone.querySelector('.zone-content');
            if (zoneContent) {
                zoneContent.innerHTML = '';
            }
            selectedTile = null;
            updateRotateButton();
        }

        function parseExpression(expr) {
            // Parse an algebraic expression into components
            // Returns an object with x2, x, and constant coefficients
            
            // Normalize the expression
            expr = expr.replace(/\s+/g, ''); // Remove spaces
            expr = expr.replace(/\*\*/g, '^'); // ** to ^
            expr = expr.replace(/\^2/g, 'Â²'); // ^2 to Â²
            expr = expr.replace(/x2/gi, 'xÂ²'); // x2 to xÂ²
            expr = expr.toLowerCase();
            
            let x2 = 0;
            let x = 0;
            let constant = 0;
            
            // Add a '+' at the beginning if the expression doesn't start with a sign
            if (expr[0] !== '+' && expr[0] !== '-') {
                expr = '+' + expr;
            }
            
            // Match all terms
            const termRegex = /([+-])\s*(\d*\.?\d*)\s*(xÂ²|x)?/g;
            let match;
            
            while ((match = termRegex.exec(expr)) !== null) {
                const sign = match[1];
                let coefficient = match[2];
                const variable = match[3];
                
                // Skip if no variable and no coefficient
                if (!variable && !coefficient) continue;
                
                // Default coefficient to 1 if not specified
                if (coefficient === '' && variable) {
                    coefficient = '1';
                }
                if (coefficient === '') coefficient = '0';
                
                let value = parseFloat(coefficient);
                if (sign === '-') value = -value;
                
                // Classify the term
                if (variable === 'xÂ²') {
                    x2 += value;
                } else if (variable === 'x') {
                    x += value;
                } else if (coefficient) {
                    constant += value;
                }
            }
            
            return { x2, x, constant };
        }

        function expressionsEqual(expr1, expr2) {
            const parsed1 = parseExpression(expr1);
            const parsed2 = parseExpression(expr2);
            
            // Compare with small tolerance for floating point errors
            const tolerance = 0.0001;
            return Math.abs(parsed1.x2 - parsed2.x2) < tolerance &&
                   Math.abs(parsed1.x - parsed2.x) < tolerance &&
                   Math.abs(parsed1.constant - parsed2.constant) < tolerance;
        }

        function checkAnswer() {
            if (!currentProblem) {
                alert('Please generate a problem first!');
                return;
            }

            const userAnswer = answerInput.value.trim();
            const correctAnswer = expressionToString(currentProblem.answer);

            // Check if expressions are mathematically equal
            const isCorrect = expressionsEqual(userAnswer, correctAnswer);

            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');

            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.textContent = 'âœ“ Correct! Well done! Click "New Problem" to try another.';
            } else {
                feedback.classList.add('incorrect');
                feedback.textContent = `âœ— Not quite. The correct answer is: ${correctAnswer}`;
            }
        }

        // Allow Enter key to submit
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });

        // Quit function
        function quitLevel() {
            if (confirm('Return to main menu?')) {
                window.location.href = 'index.html';
            }
        }

        // Help function for subtraction problems
        function showHelp() {
            if (!currentProblem || currentProblem.operation !== 'subtract') {
                return;
            }

            helpUsed = true;
            helpBtn.disabled = true;

            const expr1 = currentProblem.expr1;
            const expr2 = currentProblem.expr2;

            // Calculate how many zero pairs we need to add
            let zeroPairsX2 = 0;
            let zeroPairsX = 0;
            let zeroPairsUnit = 0;

            // For subtraction, we need enough tiles to "take away"
            // When subtracting a negative, we need to physically remove that negative tile
            // When subtracting a positive, we need to physically remove that positive tile

            if (expr2.x2 < 0) {
                // Subtracting negative xÂ² means we need to REMOVE negative xÂ² tiles
                const neededNeg = Math.abs(expr2.x2);
                const currentNeg = expr1.x2 < 0 ? Math.abs(expr1.x2) : 0;
                if (neededNeg > currentNeg) {
                    zeroPairsX2 = neededNeg - currentNeg;
                }
            } else if (expr2.x2 > 0) {
                // Subtracting positive xÂ² means we need to REMOVE positive xÂ² tiles
                const neededPos = expr2.x2;
                const currentPos = expr1.x2 > 0 ? expr1.x2 : 0;
                if (neededPos > currentPos) {
                    zeroPairsX2 = neededPos - currentPos;
                }
            }

            if (expr2.x < 0) {
                // Subtracting negative x means we need to REMOVE negative x tiles
                const neededNeg = Math.abs(expr2.x);
                const currentNeg = expr1.x < 0 ? Math.abs(expr1.x) : 0;
                if (neededNeg > currentNeg) {
                    zeroPairsX = neededNeg - currentNeg;
                }
            } else if (expr2.x > 0) {
                // Subtracting positive x means we need to REMOVE positive x tiles
                const neededPos = expr2.x;
                const currentPos = expr1.x > 0 ? expr1.x : 0;
                if (neededPos > currentPos) {
                    zeroPairsX = neededPos - currentPos;
                }
            }

            if (expr2.constant < 0) {
                // Subtracting negative units means we need to REMOVE negative unit tiles
                const neededNeg = Math.abs(expr2.constant);
                const currentNeg = expr1.constant < 0 ? Math.abs(expr1.constant) : 0;
                if (neededNeg > currentNeg) {
                    zeroPairsUnit = neededNeg - currentNeg;
                }
            } else if (expr2.constant > 0) {
                // Subtracting positive units means we need to REMOVE positive unit tiles
                const neededPos = expr2.constant;
                const currentPos = expr1.constant > 0 ? expr1.constant : 0;
                if (neededPos > currentPos) {
                    zeroPairsUnit = neededPos - currentPos;
                }
            }

            // Add zero pairs to the zero pairs content area
            let pairX = 50;
            let pairY = 20; // Start with small margin from top of content area

            let helpText = "Zero pairs added! ";
            let pairsAdded = false;

            // Add xÂ² zero pairs - 2 pairs per row
            if (zeroPairsX2 > 0) {
                helpText += `${zeroPairsX2} xÂ² pair${zeroPairsX2 > 1 ? 's' : ''} `;
                pairsAdded = true;
                for (let i = 0; i < zeroPairsX2; i++) {
                    const col = i % 3; // 3 pairs per row in bottom area
                    const row = Math.floor(i / 3);
                    const x = pairX + col * 220; // 220px = 2 tiles (100+100) + gap (20)
                    const y = pairY + row * 115;
                    
                    const tile1 = document.createElement('div');
                    tile1.className = 'tile x2-pos';
                    tile1.style.left = x + 'px';
                    tile1.style.top = y + 'px';
                    tile1.textContent = 'xÂ²';
                    tile1.dataset.id = tileCounter++;
                    tile1.dataset.rotation = '0';
                    tile1.dataset.initial = 'false';
                    tile1.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile1);
                    
                    const tile2 = document.createElement('div');
                    tile2.className = 'tile x2-neg';
                    tile2.style.left = (x + 105) + 'px';
                    tile2.style.top = y + 'px';
                    tile2.textContent = '-xÂ²';
                    tile2.dataset.id = tileCounter++;
                    tile2.dataset.rotation = '0';
                    tile2.dataset.initial = 'false';
                    tile2.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile2);
                }
                // Move down for next section
                const rows = Math.ceil(zeroPairsX2 / 3);
                pairY += rows * 115 + 10;
            }

            // Add x zero pairs
            if (zeroPairsX > 0) {
                helpText += `${zeroPairsX} x pair${zeroPairsX > 1 ? 's' : ''} `;
                pairsAdded = true;
                pairX = 50;
                for (let i = 0; i < zeroPairsX; i++) {
                    const tile1 = document.createElement('div');
                    tile1.className = 'tile x-pos';
                    tile1.style.left = pairX + 'px';
                    tile1.style.top = pairY + 'px';
                    tile1.textContent = 'x';
                    tile1.dataset.id = tileCounter++;
                    tile1.dataset.rotation = '90';
                    tile1.style.transform = 'rotate(90deg)';
                    tile1.dataset.initial = 'false';
                    tile1.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile1);
                    
                    const tile2 = document.createElement('div');
                    tile2.className = 'tile x-neg';
                    tile2.style.left = (pairX + 25) + 'px';
                    tile2.style.top = pairY + 'px';
                    tile2.textContent = '-x';
                    tile2.dataset.id = tileCounter++;
                    tile2.dataset.rotation = '90';
                    tile2.style.transform = 'rotate(90deg)';
                    tile2.dataset.initial = 'false';
                    tile2.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile2);
                    
                    pairX += 50;
                    if ((i + 1) % 10 === 0) {
                        pairX = 50;
                        pairY += 115;
                    }
                }
                if (zeroPairsX % 10 !== 0) pairY += 115;
                pairX = 50;
            }

            // Add unit zero pairs
            if (zeroPairsUnit > 0) {
                helpText += `${zeroPairsUnit} unit pair${zeroPairsUnit > 1 ? 's' : ''} `;
                pairsAdded = true;
                pairX = 50;
                for (let i = 0; i < zeroPairsUnit; i++) {
                    const tile1 = document.createElement('div');
                    tile1.className = 'tile unit-pos';
                    tile1.style.left = pairX + 'px';
                    tile1.style.top = pairY + 'px';
                    tile1.textContent = '1';
                    tile1.dataset.id = tileCounter++;
                    tile1.dataset.rotation = '0';
                    tile1.dataset.initial = 'false';
                    tile1.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile1);
                    
                    const tile2 = document.createElement('div');
                    tile2.className = 'tile unit-neg';
                    tile2.style.left = (pairX + 15) + 'px';
                    tile2.style.top = pairY + 'px';
                    tile2.textContent = '-1';
                    tile2.dataset.id = tileCounter++;
                    tile2.dataset.rotation = '0';
                    tile2.dataset.initial = 'false';
                    tile2.dataset.zone = 'zero-pairs';
                    zeroPairsContent.appendChild(tile2);
                    
                    pairX += 30;
                    if ((i + 1) % 20 === 0) {
                        pairX = 50;
                        pairY += 25;
                    }
                }
            }

            if (pairsAdded) {
                helpText += `(positive + negative = 0). Now you can subtract ${expressionToString(expr2)}.`;
                helpMessage.textContent = helpText;
                helpMessage.classList.add('show');
            } else {
                helpMessage.textContent = "You already have enough tiles to complete the subtraction!";
                helpMessage.classList.add('show');
            }
        }

        // Prevent default drag behavior
        document.addEventListener('dragstart', (e) => e.preventDefault());

        // Generate first problem on load
        generateNewProblem();
    </script>
</body>
</html>
